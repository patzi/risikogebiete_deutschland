<!DOCTYPE html>
<html lang="de" id="top">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>Risikogebiete Deutschland</title>
    <meta content="" name="description">
    <meta content="COVID-19, RISIKO, DEUTSCHLAND" name="keywords">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"/>
    <meta http-equiv="pragma" content="no-cache">
    <meta http-equiv="expires" content="-1">


    <!-- Bootstrap CSS -->
    <link href="assets/css/bootstrap/bootstrap.min.css" rel="stylesheet">

    <!-- Master CSS -->
    <link href="assets/css/main.css" rel="stylesheet">

    <!-- Projection -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.5.0/proj4.js"></script>

    <!-- D3 js-->
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <!-- HDF5 js-->
    <script src="https://cdn.jsdelivr.net/gh/usnistgov/jsfive@master/dist/hdf5.js"></script>

    <!-- Own utils-->
    <script src="assets/js/utils.js"></script>
</head>
<body>

<!-- Element for the map-->
<div id="map__container" style="width: fit-content; height:95vh"></div>

<!-- Slider for iterating days-->
<div class="slidecontainer">
    <input type="range" min="-100" max="0" value="0" step="1" class="slider" id="slider_days">
</div>

</body>
<script>

/* ------------------------------------------------------------
 *  Global variables
 * ------------------------------------------------------------ */
// Colormap
var color = d3.scaleLinear()
    .domain([10,25,100])
    .range(["green", "orange", "red"]);
// Data
var h5_data, geojson;



/* Draw the map to an div container with id "map__container"
*/ 
function setup_svgmap(){
    // Get window size
    let height = window.innerHeight*0.95;
    var width = window.innerWidth;
    // Create svg inside map container
    var svg = d3
        .select("#map__container")
        .append("svg")
        .attr("height", height);

    // Define identity projection
    // Own projection is done beforehand (see data loading)
    var projection = d3.geoIdentity().reflectY(true).fitHeight(height,geojson);
    var path = d3.geoPath(projection);

    // Draw the map as svg
    svg.selectAll("path")
        .data(geojson.features)
        .enter()
        .append("path")
        .attr("d",path)
        .attr("fill", "white")
        .attr("stroke", "white")
        .attr("stroke-width","1.5");
        
  
    // Select inital some data
    let date = new Date("2021-11-22").getTime()/1000; //YYYY-MM-DD
    let age_group = "total";

    update_geojson(date,age_group)

    // Plot initial selected data
    triggerTransition(0);


    // Draw legend in a new group
    var colors = color.range().reverse().map((d,i)=>{
        return {
            color: d,
            offset: String(i/(color.range().length-1)*100)+"%"
        }
    });
    let legend_width = 20, legend_height = height/0.95*0.6;
    add_legend_gradient(svg, colors, legend_width, legend_height,[svg.node().getBBox().width+1.5*legend_width,svg.node().getBBox().height/2-legend_height/2]);

    // Update svg width
    svg.attr("width",svg.node().getBBox().width);

}

/* Update geojsons data for timeseries plotting
*/
function update_geojson(date, age_group){


    // We stop looking for more dates once
    // we found the block with the same
    // dates, they are always chronological
    // since the data is sorted by date first!
    var index_1 = [];
    let found = false;
    for(let i = 0; i < h5_data.date.length; i++){
        if (h5_data.date[i] == date){
            found = true;
            index_1.push(i);
        }
        else if (found && index_1.length>0) {
            break;
        }
    }
    
    var index_2 = [];

    index_1.forEach(element => {
        if (h5_data.Altersgruppe[element] == h5_data.age_groups_label.indexOf(age_group)){
            index_2.push(element);
        }
    });
    geojson.features.forEach(el => {
        const linkedData = index_2.find(d => h5_data.IdLandkreis[d] == parseInt(el.properties.AGS));
        el.properties.index_data = linkedData;
    });
}

function triggerTransition(i){
    update_geojson(new Date("2021-11-22").getTime()/1000 + 86400*i,"total");

    let test = d3.select("svg")
        .selectAll("path")
        .attr("fill", d => {
            return color(h5_data.inzidenz[d.properties.index_data])
        });
}    

//Add event to slider
document.getElementById("slider_days").addEventListener("input", throttle(function() {
    triggerTransition(document.getElementById("slider_days").value);
},0));

// Load geojson file and fetch timeseries
Promise.all([
    d3.json("assets/data/landkreise_edited.geojson")
        .then((r)=>{
            // Own projection
            project(
                r,
                '+proj=merc +lat_1=33 +lat_2=45 +lat_0=0 +lon_0=0'
            );
            return r
        }),
    fetch("assets/data/timeseries.hdf5")
        .then((r)=>{
            return r.arrayBuffer()
        })
        .then((r)=>{
            return new hdf5.File(r)
        })
        .then((f)=>{
            h5_data = {
                date: f.get('data/date').value,
                IdLandkreis: f.get('data/IdLandkreis').value,
                Altersgruppe: f.get('data/Altersgruppe').value,
                inzidenz: f.get('data/inzidenz').value,
                weekly_cases: f.get('data/weekly_cases').value,
                age_groups_label:  f.get('age_groups_label').value,
                age_groups_values:  f.get('age_groups_value').value,
            };
            return h5_data;
        })
]).then((data)=>{
    // Plotting setup
    geojson = data[0];
    setup_svgmap();
});
</script>
</html>